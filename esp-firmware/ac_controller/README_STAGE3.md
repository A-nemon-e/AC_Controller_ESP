# ESPå›ºä»¶ - é˜¶æ®µä¸‰å®Œæˆ

## âœ… å·²å®ç°åŠŸèƒ½

### çº¢å¤–å­¦ä¹ æ¨¡å— (ir_learning.h/.cpp)
- âœ… å¯åŠ¨/åœæ­¢å­¦ä¹ æ¨¡å¼
- âœ… æ•è·é¥æ§å™¨åŸå§‹æ•°æ®
- âœ… 30ç§’è¶…æ—¶å¤„ç†
- âœ… å­¦ä¹ ç»“æœMQTTå‘å¸ƒ
- âœ… LEDæŒ‡ç¤ºï¼ˆå­¦ä¹ æ¨¡å¼å¿«é—ªï¼‰

### Ghostæ£€æµ‹å™¨ (ghost_detector.h/.cpp)
- âœ… éº¦å…‹é£ä¿¡å·ç›‘æµ‹
- âœ… çº¢å¤–+éº¦å…‹é£æ—¶é—´çª—å£å¯¹æ¯”
- âœ… Ghostäº‹ä»¶æ£€æµ‹å’Œå‘å¸ƒ
- âœ… å¯é…ç½®çµæ•åº¦å’Œçª—å£æ—¶é—´
- âœ… æ”¯æŒéº¦å…‹é£é…ç½®æ›´æ–°

### çŠ¶æ€ç®¡ç†å™¨ (state_manager.h/.cpp)
- âœ… ç©ºè°ƒçŠ¶æ€ç»´æŠ¤
- âœ… JSONçŠ¶æ€æ›´æ–°
- âœ… çŠ¶æ€MQTTå‘å¸ƒï¼ˆå«ä¼ æ„Ÿå™¨æ•°æ®ï¼‰
- âœ… å¤šæ¥æºæ”¯æŒï¼ˆapi, ir_recv, manualï¼‰
- âœ… EEPROMæŒä¹…åŒ–æ¥å£ï¼ˆé¢„ç•™ï¼‰

### ä¸»ç¨‹åºæ›´æ–°
- âœ… é›†æˆæ‰€æœ‰ä¸‰ä¸ªæ¨¡å—
- âœ… çº¢å¤–æ¥æ”¶å›è°ƒé“¾è·¯
- âœ… å­¦ä¹ å‘½ä»¤å¤„ç†
- âœ… Ghostæ£€æµ‹é›†æˆ
- âœ… çŠ¶æ€ç®¡ç†é›†æˆ

---

## ğŸ“¡ æ–°å¢MQTTæ¶ˆæ¯

### ä¸‹è¡Œï¼ˆæœåŠ¡å™¨ â†’ ESPï¼‰

#### 1. å­¦ä¹ æŒ‡ä»¤
```json
Topic: ac/user_{userId}/dev_{uuid}/learn/start
{
  "key": "cool_26"
}
```

#### 2. æ§åˆ¶å‘½ä»¤ï¼ˆå®Œæ•´
ï¼‰
```json
Topic: ac/user_{userId}/dev_{uuid}/cmd
{
  "power": true,
  "mode": "cool",
  "temp": 26,
  "fan": 2,
  "swingVertical": true,
  "swingHorizontal": false,
  "raw": "9000,4500,..."  // å¯é€‰
}
```

### ä¸Šè¡Œï¼ˆESP â†’ æœåŠ¡å™¨ï¼‰

#### 1. å­¦ä¹ ç»“æœ
```json
Topic: ac/user_{userId}/dev_{uuid}/learn/result
{
  "key": "cool_26",
  "raw": "9000,4500,560,1680,...",
  "success": true,
  "timestamp": 123456
}
```

#### 2. å­¦ä¹ è¶…æ—¶
```json
Topic: ac/user_{userId}/dev_{uuid}/learn/result
{
  "key": "cool_26",
  "success": false,
  "error": "timeout"
}
```

#### 3. Ghostäº‹ä»¶
```json
Topic: ac/user_{userId}/dev_{uuid}/event
{
  "type": "ghost",
  "timestamp": 123456,
  "timeSinceMic": 35000
}
```

#### 4. çŠ¶æ€ä¸ŠæŠ¥ï¼ˆå¢å¼ºç‰ˆï¼‰
```json
Topic: ac/user_{userId}/dev_{uuid}/status
{
  "power": true,
  "mode": "cool",
  "targetTemp": 26,
  "fan": 2,
  "swingVertical": true,
  "swingHorizontal": false,
  "source": "api",
  "temp": 26.5,
  "hum": 60.2,
  "current": 1.23,
  "timestamp": 123456
}
```

---

## ğŸ® ä½¿ç”¨æµç¨‹

### æµç¨‹1ï¼šå­¦ä¹ é¥æ§å™¨æŒ‰é”®

```
1. å‰ç«¯ç‚¹å‡»"å­¦ä¹ æŒ‰é”®"ï¼Œè¾“å…¥key="cool_26"
2. åç«¯å‘é€MQTT: ac/.../learn/start {"key":"cool_26"}
3. ESPè¿›å…¥å­¦ä¹ æ¨¡å¼ï¼ˆLEDå¿«é—ªï¼‰
4. ç”¨æˆ·æŒ‰é¥æ§å™¨"26åº¦åˆ¶å†·"æŒ‰é’®
5. ESPæ•è·åŸå§‹æ•°æ®
6. ESPå‘å¸ƒ: ac/.../learn/result {"key":"cool_26","raw":"..."}
7. åç«¯ä¿å­˜åˆ°æ•°æ®åº“irConfigå­—æ®µ
```

### æµç¨‹2ï¼šä½¿ç”¨å­¦ä¹ çš„æŒ‰é”®

```
1. å‰ç«¯ç‚¹å‡»"26åº¦åˆ¶å†·"
2. åç«¯ä»æ•°æ®åº“è¯»å–irConfig["cool_26"]
3. åç«¯å‘é€: ac/.../cmd {"raw":"9000,4500,..."}
4. ESPå‘é€çº¢å¤–ä¿¡å·
5. ç©ºè°ƒæ‰§è¡Œå‘½ä»¤
6. ESPæ›´æ–°çŠ¶æ€å¹¶å‘å¸ƒ
```

### æµç¨‹3ï¼šGhostæ£€æµ‹

```
1. ç”¨æˆ·ç›´æ¥ç”¨é¥æ§å™¨æ§åˆ¶ç©ºè°ƒï¼ˆä¸é€šè¿‡ESPï¼‰
2. ESPçº¢å¤–æ¥æ”¶åˆ°ä¿¡å·
3. Ghostæ£€æµ‹å™¨æ£€æŸ¥ï¼šéº¦å…‹é£æ˜¯å¦åœ¨30ç§’å†…è§¦å‘
4. å¦‚æœæœªè§¦å‘ â†’ å‘å¸ƒGhostäº‹ä»¶
5. å‰ç«¯æ”¶åˆ°WebSocketé€šçŸ¥ï¼š"æ£€æµ‹åˆ°æ‰‹åŠ¨æ“ä½œ"
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æµ‹è¯•1ï¼šå­¦ä¹ åŠŸèƒ½

```bash
# å‘é€å­¦ä¹ æŒ‡ä»¤
mosquitto_pub -h server.com \
  -t "ac/user_1/dev_esp_001/learn/start" \
  -m '{"key":"test_key"}'

# ESPè¿›å…¥å­¦ä¹ æ¨¡å¼ï¼ŒLEDå¿«é—ª
# æŒ‰é¥æ§å™¨ä»»æ„é”®
# æŸ¥çœ‹MQTTæ¶ˆæ¯
```

### æµ‹è¯•2ï¼šGhostæ£€æµ‹

```bash
# 1. ç¡®ä¿éº¦å…‹é£å·²å¯ç”¨
# 2. ç›´æ¥ç”¨é¥æ§å™¨æ§åˆ¶ç©ºè°ƒ
# 3. è§‚å¯ŸMQTTæ¶ˆæ¯
# åº”æ”¶åˆ°: {"type":"ghost",...}
```

### æµ‹è¯•3ï¼šçŠ¶æ€ç®¡ç†

```bash
# å‘é€æ§åˆ¶å‘½ä»¤
mosquitto_pub -h server.com \
  -t "ac/user_1/dev_esp_001/cmd" \
  -m '{"power":true,"mode":"cool","temp":26}'

# è§‚å¯ŸçŠ¶æ€ä¸ŠæŠ¥åŒ…å«å®Œæ•´ä¿¡æ¯
```

---

## ğŸ”‘ å…³é”®è®¾è®¡ç‚¹

### 1. å­¦ä¹ æ¨¡å¼è¶…æ—¶

- 30ç§’æ— ä¿¡å·è‡ªåŠ¨é€€å‡º
- LEDæ¢å¤æ­£å¸¸æ˜¾ç¤º
- å‘å¸ƒtimeoutæ¶ˆæ¯

### 2. Ghostæ£€æµ‹é€»è¾‘

```cpp
IF (æ”¶åˆ°çº¢å¤–) AND (è·ä¸Šæ¬¡éº¦å…‹é£ > 30ç§’):
  â†’ å‘å¸ƒGhostäº‹ä»¶
ELSE:
  â†’ æ­£å¸¸æ“ä½œ
```

### 3. çŠ¶æ€æ¥æºæ ‡è®°

- `api` - é€šè¿‡MQTTå‘½ä»¤
- `ir_recv` - é¥æ§å™¨æ§åˆ¶
- `manual` - æ‰‹åŠ¨ï¼ˆä¿ç•™ï¼‰

### 4. å›è°ƒé“¾è·¯

```
çº¢å¤–æ¥æ”¶ â†’ onIRReceived()
         â”œâ”€ å­¦ä¹ æ¨¡å¼ï¼Ÿâ†’ IRLearning::onIRReceived()
         â”œâ”€ Ghostæ£€æµ‹ â†’ GhostDetector::onIRReceived()
         â””â”€ çŠ¶æ€æ›´æ–° â†’ StateManager::setState()
```

---

## ğŸ“š ä»£ç æ–‡ä»¶æ¸…å•

**é˜¶æ®µä¸‰æ–°å¢**:
- `ir_learning.h` / `ir_learning.cpp`
- `ghost_detector.h` / `ghost_detector.cpp`
- `state_manager.h` / `state_manager.cpp`

**æ›´æ–°æ–‡ä»¶**:
- `ac_controller.ino` - ä¸»ç¨‹åºï¼ˆå®Œæ•´é›†æˆï¼‰

**å·²æœ‰æ–‡ä»¶** (é˜¶æ®µä¸€ã€äºŒ):
- config.h, config_manager.*
- wifi_manager.*, mqtt_client.*
- sensors.*, ir_controller.*
- led_indicator.*

---

## ğŸ¯ å®Œæˆåº¦

- âœ… WiFié…ç½‘å’Œç®¡ç†
- âœ… MQTTé€šä¿¡
- âœ… OTAé…ç½®ç³»ç»Ÿ
- âœ… AHT20æ¸©æ¹¿åº¦
- âœ… ADCç”µæµé‡‡æ ·
- âœ… çº¢å¤–æ”¶å‘
- âœ… **çº¢å¤–å­¦ä¹ ** â­
- âœ… **Ghostæ£€æµ‹** â­
- âœ… **çŠ¶æ€ç®¡ç†** â­

**æ ¸å¿ƒåŠŸèƒ½å®Œæˆåº¦ï¼š95%**

---

## ğŸ”œ ä¸‹ä¸€æ­¥ï¼ˆé˜¶æ®µå››ï¼šé›†æˆæµ‹è¯•ï¼‰

- [ ] å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆ24å°æ—¶ï¼‰
- [ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•
- [ ] å†…å­˜æ³„æ¼æ£€æŸ¥
- [ ] åˆ›å»ºwalkthroughæ–‡æ¡£

å½“å‰è¿›åº¦ï¼š**é˜¶æ®µä¸‰å®Œæˆ** âœ…
